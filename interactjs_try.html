<!--
Copyright (C) 2019 by
  Robert L. Read <read.robert@gmail.com>

  This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <title>Social Tetrahedra</title>
    <meta name="description" content="Experiments with graphical representations">
    <meta name="author" content="Robert L. Read">

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="shortcut icon" type="image/ico" href="./images/favicon.ico"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.0/bootstrap-slider.js"></script>

    <script src="./js/three.js"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-1.12.1.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/interactjs@1.3/dist/interact.min.js"></script>

    <link rel="stylesheet" href="./css/bootstrap-slider.css"></script>

    <link rel="stylesheet" href="./css/main.css">


    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="./js/scijs-newton-raphson.js"></script>
    <script src="./js/tm_bundle.js"></script>
    <script src="./js/axes.js"></script>
    <script src="./js/three.js"></script>
    <script src="./js/THREE.MeshLine.js"></script>
    <script src="./js/OrbitControls.js"></script>
    <script src="./js/Detector.js"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="./js/d3-scale.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale.v1.min.js"></script>

    <style>

#ex1Slider .slider-selection {
	background: #BABABA;
}
      /* Tabs*/
section {
    padding: 60px 0;
}

section .section-title {
    text-align: center;
    color: #007b5e;
    margin-bottom: 50px;
    text-transform: uppercase;
}
#tabs{
	background: #007b5e;
    color: #eee;
}
#tabs h6.section-title{
    color: #eee;
}

#tabs .nav-tabs .nav-item.show .nav-link, .nav-tabs .nav-link.active {
    color: #f3f3f3;
    background-color: transparent;
    border-color: transparent transparent #f3f3f3;
    border-bottom: 4px solid !important;
    font-size: 20px;
    font-weight: bold;
}
#tabs .nav-tabs .nav-link {
    border: 1px solid transparent;
    border-top-left-radius: .25rem;
    border-top-right-radius: .25rem;
    color: #eee;
    font-size: 20px;
}

canvas {
    border: 1px solid black;
width: 100%;
}

    </style>

    <style>
      body { font-family: Helvetica, Arial, sans-serif; }

.dropzone-wrapper {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
}

.dropzone {
    overflow: hidden;
    margin: .5em;
    padding: 1em;
    color: #666;
    text-align: center;
    background: #ccc;
    line-height: 8em;
    border: 4px dashed transparent;
    transition: background .15s linear, border-color .15s linear;
}

.dropzone.-drop-possible { border-color: #666; }

.dropzone.-drop-over {
    background: #666;
    color: #fff;
}

.draggable {
    position: relative;
    z-index: 10;
    width: 400px;

    margin: .25em;
    padding: 1em 2em;
    background-color: #29e;
    color: #fff;
    text-align: center;

    -ms-touch-action: none;
        touch-action: none;
}

    .draggable.-drop-possible { background-color: #42bd41; }

#nav-tabContent {
    overflow-y: scroll;
    height: 600px;
}

      </style>

<body>
  <br>
  <div class="container">
    <h1 class="section-title h1">Social Tetrahedra</h1>

    <h2>First Three Dimensions</h2>
    <div>
      <button type="button" class="btn btn-primary" id="MBS">Mind/Body/Spirit</button>
      <button type="button" class="btn btn-secondary" id="HHH">Head/Heart/Hands</button>
      <button type="button" class="btn btn-success" id="PSM">Physical/Social/Mental</button>
      <button type="button" class="btn btn-danger" id="SEF">Strength/Endurance/Flexibility</button>
      <button type="button" class="btn btn-warning" id="PBC">Personal/Business/Civic</button>
    </div>

<!--
    <fieldset>
      <span id="normToUse">Balancing Norm to Use: </span>
      <label for="l1norm">L1 Norm (Absolute Value):</label>
      <input type="radio" name="norm" id="l1norm" checked="checked">
      <label for="l2norm">L2 Norm (Sqrt of Squares):</label>
      &nbsp;
      <input type="radio" name="norm" id="l2norm">
  </fieldset>
  -->

    <fieldset>

      <label for="d3name">Fourth Dimension Name:</label>
      <input type="text" id="d3name" value="Abundance"></input>
      <label for="balancefourth">Balance fourth with Norm:</label>
      <input type="checkbox" name="balancefourth" id="balancefourth">
    </fieldset>

    <fieldset style="display: inline}">
      <label for="d0" id="d0l">Mind: </label>
      <span type="text" id="d0">0%</span>
      <label for="d1" id="d1l">, Body: </label>
      <span type="text" id="d1">0%</span>
      <label for="d2" id="d2l">, Spirit: </label>
      <span type="text" id="d2">0%</span>
      <label for="d3" id="d3l">, Abundance: </label>
      <span type="text" id="d3">0%</span>
    </fieldset>


</section>


<div class="row">
  <div class="col-6">
    <!-- <nav> -->
    <!--   <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist"> -->
    <!--     <a class="nav-item nav-link active" id="nav-create-tab" data-toggle="tab" href="#nav-create" role="tab" aria-controls="nav-create" aria-selected="true">Create Social Tetrahedrons</a> -->
    <!--     <a class="nav-item nav-link" id="nav-show-tab" data-toggle="tab" href="#nav-social" role="tab" aria-controls="nav-show" aria-selected="false">Show Social Tetrahedrons</a> -->
    <!--   </div> -->
    <!-- </nav> -->
    <!-- <div class="tab-content py-3 px-3 px-sm-0" id="nav-tabContent"> -->
    <!--   <div class="tab-pane fade show active" id="nav-create" role="tabpanel" aria-labelledby="nav-create-tab"> -->
        <div class="row">
          <div class="col">
            <div class="row">
              <div class="col-2 col-sm-1">
                <input id="fourthslider" type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="0" data-slider-orientation="vertical"/>
              </div>
              <div class="col-4 col-sm-11">
                <div id="create-canvas">
                  <svg id="create_svg"  class="dropzone js-drop" height="400px" width="400px" viewbox="-200 -200 400 400">
                  </svg>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-2 col-sm-1">
              </div>
              <div class="col-4 col-sm-11">
                <div id="threecontainer" height="800px" width="500px"></div>
</div>
            </div>
          </div>
      <!--   </div> -->
      <!-- </div> -->
    </div>
  </div>
  <div class="col-6">
    <nav>
      <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
	<a class="nav-item nav-link active" id="nav-projects-tab" data-toggle="tab" href="#nav-projects" role="tab" aria-controls="nav-projects" aria-selected="true">Projects</a>
	<a class="nav-item nav-link" id="nav-persons-tab" data-toggle="tab" href="#nav-persons" role="tab" aria-controls="nav-persons" aria-selected="false">Persons</a>
	<a class="nav-item nav-link" id="nav-places-tab" data-toggle="tab" href="#nav-places" role="tab" aria-controls="nav-places" aria-selected="false">Places</a>
	<a class="nav-item nav-link" id="nav-tools-tab" data-toggle="tab" href="#nav-tools" role="tab" aria-controls="nav-tools" aria-selected="false">Tools</a>
      </div>
    </nav>
    <div class="tab-content py-3 px-3 px-sm-0" id="nav-tabContent" >
      <div class="tab-pane fade show active" id="nav-projects" role="tabpanel" aria-labelledby="nav-projects-tab">

        <ul class="list-group" id="nav-projects-list" >
          <li class="list-group-item active">Cras justo odio</li>
        </ul>
      </div>
      <div class="tab-pane fade" id="nav-persons" role="tabpanel" aria-labelledby="nav-persons-tab">
        <ul class="list-group" id="nav-persons-list">
          <li class="list-group-item active">Cras justo odio</li>
        </ul>

      </div>
      <div class="tab-pane fade" id="nav-places" role="tabpanel" aria-labelledby="nav-places-tab">
        <ul class="list-group" id="nav-places-list">
          <li class="list-group-item active">Cras justo odio</li>
        </ul>
      </div>
      <div class="tab-pane fade" id="nav-tools" role="tabpanel" aria-labelledby="nav-tools-tab">
        <ul class="list-group" id="nav-tools-list">
          <li class="list-group-item active">Cras justo odio</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<section>
  <h1>
    Social Tetrahedra
  </h1>
  <p>
    This is an <a href="">open source demonstration project</a> of <a href="https://pubinv.github.io/PubInv/">Public Invention</a>
    based on downloadable <a href="https://github.com/PubInv/SocialTetrahedrons/blob/master/Prototype-TetrahedralProfile-V2.docx">ideas</a> by Mark Frazier.
  </p>
  <h2>Usage</h2>
  To specify the relative attributes of a project, person, place, or tool, first use the slider on the left
  to specify the 4th dimension. Then drag a project, person, place or tool onto the triangle. These three
  coordinates are considered "balanced", that is, the position on the triangle specifies them with a
  particular algorithm. The closer to one corner of the triangle you are, the more strongly you reflect that
  attribute. The center of the trinagle reflects all attributes equally--that is, "perfect balance."
  The weights of these attributes will be recorded with your assertion, and displayed (temporarily) below the
  triangle.
  <h2>The Fourth Dimension</h2>
  In Mark's conception, the fourth dimension is "abundance" or "condition", which may
  be thought of as power or development. It is represented as a slider on the
  left. The checkbox labeled "Balance fourth with Norm" controls whether
  this dimension is thought of as separate, or whether we require a length 1
  vector of all for dimensions.
  <h2 id="message_banner">Usage of the 3D View</h2>
  <p> This is an interactive 3D simulation. To change the view, place your mouse in the view area, and
    hold and "drag" the mouse to rotate the image.
    The mouse wheel or a drag on your trackpad should zoom you in or out.</p>
  <p>All of the code on this site is released under the Affero GNU General Public License, and I hope you will
    reuse it. </p>

  <h2>Purpose</h2>
  <p>The ultimate purpose is to match needs with offers, for example to work on technical projects, base on an interpretation
    of Maslow's Pyramid, having four dimenstions.  People express their desires by placing themselves on a tetrahedron that
    captures, for example, the Mind/Body/Spirt and Abundance situation, and might then be matched with projects that
    are suited to them. Exactly how this will be done is still being worked out; this is a step.
  </p>
  <h2>License</h2>
  You are free to reuse this software under the terms
  of the GNU Affero General Public License.
</section>
</div>

</div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <script src="./js/bootstrap-slider.js"></script>

    <script src="./js/TriadBalance.js"></script>

<script>
var WORLD_TRIANGLE_COORDS;
const w = 400;
const h = 400;

const TRIANGLE_WIDTH = 1;
const TRIANGLE_HEIGHT = Math.sqrt(3)/2;
const SIDE_LENGTH_PIXEL = 300;
const SIDE_LENGTH_HEIGHT = SIDE_LENGTH_PIXEL * TRIANGLE_HEIGHT;
const BASE = -(1/3) * SIDE_LENGTH_HEIGHT;

function get_world_triangle() {
    let wtc_vector = [new THREE.Vector2(-SIDE_LENGTH_PIXEL/2,BASE),
               new THREE.Vector2(SIDE_LENGTH_PIXEL/2,BASE),
               new THREE.Vector2(0,BASE+SIDE_LENGTH_HEIGHT)];
    return wtc_vector;
}

// These function convert my abstract coordinates
// to svg coordinates.
function vph(h,y) { return (-y); }
function vpw(w,x) { return (x); }


</script>

<script src="./js/main.js"></script>

<script>


// OBJECTS
// Effectively thise arrays represent an in-memory databes before we hook up Redis or Firebase or something.

var PROJECTS = [];
var PERSONS = [];
var PLACES = [];
var TOOLS = [];
var RSLIDER;

var THREE_DIMENSIONS = { "MBS": ["Mind","Body","Spirit"],
                         "HHH": ["Head","Heart","Hands"],
                         "PSM": ["Physical","Social","Mental"],
                         "SEF": ["Strength","Endurance","Flexibility"],
                         "PBC": ["Personal","Business","Civic"]
                       };
var CURRENT_D = "MBS";

// Now some constructors to give these things some shapes

function Project(name,source,url) {
    this.name = name;
    this.source = source;
    this.url = url;
}

function Person(name,email) {
    this.name = name;
    this.email = email;
}

function Place(name,lat,lon) {
    this.lat = lat;
    this.lon = lon;
    this.name = name;
}

function Tool(name,level) {
    this.name = name;
    this.level = level;
}

function TetType(type,A_name,B_name,C_name,D_name) {
    this.type = type;
    this.A_Name = A_name;
    this.B_Name = B_name;
    this.C_Name = C_name;
    this.D_Name = D_name;
}

function MBSCTet() {
    TetType.call(this,"MBSC","Mind","Body","Spirit","Comfort");
}

function Tetrahedron(key,type) {
    this.key = key;
    this.type = type;
    // I'm assuming these are the four independent dimensions
    // and that the type gives the names of these dimensions
    this.A = 0;
    this.B = 0;
    this.C = 0;
    this.D = 0;
}

// Now, before I will create a function to populate a test database....
function InitProjects() {
    PROJECTS.push(new Project('Project #1','Public Invention',''));
    PROJECTS.push(new Project('Project #2,','Public Invention',''));
    PROJECTS.push(new Project('Project #4','Public Invention',''));
    PROJECTS.push(new Project('Project #4','Public Invention',''));
}
function InitDatabase() {
    InitProjects();
    PROJECTS.push(new Project('Gluss (robotic truss))','Public Invention','https://pubinv.github.io/tetrobot/'));
    PROJECTS.push(new Project('Geotagtext','Public Invention','https://github.com/PubInv/geotagtext'));
    PERSONS.push(new Person('Robert L. Read','read.robert@gmail.com'));
    PERSONS.push(new Person('Mark Frazier','yadayada@gmail.com'));
    PLACES.push(new Place('Poindexter\'s Lab',30.252408, -97.774618));
    TOOLS.push(new Tool('JavaScript',4));
}

function list_item(content) {
    return '<li class="list-group-item">'+content+'</li>';
}
function list_item_draggable(content) {
    return '<li class="list-group-item draggable js-drag">'+content+'</li>';
}
// These function convert my abstract coordinates
// to canvas coordinates.
function vph(h,y) { return (-y); }
function vpw(w,x) { return (x); }

var ADDED_TET_PROJs = [];
var ADDED_TET_PERSs = [];
var ADDED_TET_PLACs = [];
var ADDED_TET_TOOLs = [];

var CUR_TRIANGLE_COORDS;

function append_text(svg,x,y,text) {
    var newText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    newText.setAttributeNS(null,"x",x);
    newText.setAttributeNS(null,"y",y);
    var textNode = document.createTextNode(text);
    newText.appendChild(textNode);
    svg.appendChild(newText);
}


function render_create_svg() {
    var svg = $("#create_svg")[0];
    $("#create_svg").empty();
    var polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    svg.appendChild(polygon);

    let wtc = WORLD_TRIANGLE_COORDS;

    var array = [ [ vpw(w,wtc[0].x),vph(h,wtc[0].y) ],
                  [ vpw(w,wtc[1].x),vph(h,wtc[1].y) ],
                  [ vpw(w,wtc[2].x),vph(h,wtc[2].y) ] ];

    for (value of array) {
        var point = svg.createSVGPoint();
        point.x = value[0];
        point.y = value[1];
        polygon.points.appendItem(point);
    }
    polygon.style.fill='lemonchiffon';

    // These are ugly, they should really be computed from the text.
    // In fact, since this does not change, the whole thing could go into
    // HTML and css more profitably.

    append_text(svg,array[2][0]-20,array[2][1]-5,
                THREE_DIMENSIONS[CURRENT_D][2]);
    append_text(svg,array[0][0]-40,array[0][1]+20,
                THREE_DIMENSIONS[CURRENT_D][0]);
    append_text(svg,array[1][0],array[1][1]+20,
                THREE_DIMENSIONS[CURRENT_D][1]);

  for(var i = 0; i < 3; i++) {
    DIMENSION_NAMES[i] = THREE_DIMENSIONS[CURRENT_D][i];
  }
  DIMENSION_NAMES[i] = $("#d3name").val();

    var circle = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
    circle.setAttributeNS(null, 'cx', vpw(w,0));
    circle.setAttributeNS(null, 'cy', vph(h,0));
    circle.setAttributeNS(null, 'r', 2);
    circle.setAttributeNS(null, 'style', 'fill: black; stroke: black; stroke-width: 1px;' );
    svg.appendChild(circle);

    function add_triangle(tri,c) {
        if (tri) {
            var polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            svg.appendChild(polygon);
            var F = 0.05;

            var array = arr = [ [ vpw(w,tri.x + F*-SIDE_LENGTH_PIXEL/2),vph(h,tri.y + F*BASE) ],
                                [ vpw(w,tri.x + F*SIDE_LENGTH_PIXEL/2),vph(h,tri.y + F*BASE) ],
                                [ vpw(w,tri.x + 0),vph(h,tri.y + F*(BASE+SIDE_LENGTH_HEIGHT)) ] ];
            for (value of array) {
                var point = svg.createSVGPoint();
                point.x = value[0];
                point.y = value[1];
                polygon.points.appendItem(point);
            }
            polygon.style.fill=c;
            svg.appendChild(polygon);
        }
    }

    ADDED_TET_PROJs.forEach( atp => add_triangle(atp,"blue"));
    ADDED_TET_PERSs.forEach( atp => add_triangle(atp,"red"));
    ADDED_TET_PLACs.forEach( atp => add_triangle(atp,"green"));
    ADDED_TET_TOOLs.forEach( atp => add_triangle(atp,"orange"));
}

function render_types(groupid,array,f) {
    //actually, we need an Html element to add to here,
    //but I will just do this.
    $(groupid).empty();
    array.forEach(p => {
        $(groupid).append(list_item_draggable(f(p)));
    });
}

function render_svgs() {
    render_create_svg();
}

function main_social() {
    InitDatabase();
    render_types('#nav-projects-list',PROJECTS,(p => p.name));
    render_types('#nav-persons-list',PERSONS,(p => p.name));
    render_types('#nav-places-list',PLACES,(p => p.name));
    render_types('#nav-tools-list',TOOLS,(p => p.name));
    render_svgs();

    $("#fourthslider").slider({
	reversed : true
    });

    var SliderChange = function() {
        $("#d3").text(RSLIDER.getValue() +  "%" );
        setBalance(CUR_TRIANGLE_COORDS);
    }
    RSLIDER = $('#fourthslider').slider()
	.on('slideStop', SliderChange)
	.data('slider');

    function set_dimension_labels(cur) {
        $("#d0l").text(THREE_DIMENSIONS[cur][0] + ":");
        $("#d1l").text(", " + THREE_DIMENSIONS[cur][1] + ":");
        $("#d2l").text(", " + THREE_DIMENSIONS[cur][2] + ":");
        $("#d3l").text(", " + $("#d3name").val() + ":");
    }
    function set_and_render(cur) {
        CURRENT_D = cur;
      set_dimension_labels(CURRENT_D);
      var names = [];
      for(var i = 0; i < 3; i++) {
        names[i] = THREE_DIMENSIONS[CURRENT_D][i];
      }
      names[3] = $("#d3name").val();
      set_dimension_names(names);
      render_svgs();
      update_dimension_names();
    }

    $("#MBS").click(() => { set_and_render("MBS");});
    $("#HHH").click(() => { set_and_render("HHH");});
    $("#PSM").click(() => { set_and_render("PSM");});
    $("#SEF").click(() => { set_and_render("SEF");});
    $("#PBC").click(() => { set_and_render("PBC");});

    $("#d3").change(() => {
        set_dimension_labels(CURRENT_D);
        render_svgs();
    }
                   );
}

$( document ).ready(function() {

    main_social();
});


let transformProp;

interact.maxInteractions(Infinity);

var ORIG_CUR_POS;
var startPos;
var CUR_WIDTH;
var CUR_HEIGHT;
var CUR_FONT_SIZE;
var CUR_TEXT;

// setup draggable elements.
interact('.js-drag')
    .draggable({
        max: Infinity,
    })
    .on('dragstart', function (event) {
        event.interaction.x = parseInt(event.target.getAttribute('data-x'), 10) || 0;
        event.interaction.y = parseInt(event.target.getAttribute('data-y'), 10) || 0;
        if (!startPos) {
            var rect = interact.getElementRect(event.target);
            CUR_POS_X = event.clientX - rect.left;
            CUR_POS_Y = event.clientY - rect.top;

            // record center point when starting the very first a drag
            startPos = {
                x: rect.left + rect.width  / 2,
                y: rect.top  + rect.height / 2
            }
            CUR_WIDTH = event.target.style.width;
            CUR_HEIGHT = event.target.style.height;
            CUR_FONT_SIZE = event.target.style.fontSize;
            CUR_TEXT = event.target.textContent;
        };
    })
    .on('dragend',function (event) {
        event.target.style.width = CUR_WIDTH;
        event.target.style.height = CUR_HEIGHT;
        event.target.style.fontSize = CUR_FONT_SIZE;
        event.target.textContent = CUR_TEXT;
        event.target.style.left = "" + 0 + "px";
        event.target.style.top = "" + 0 + "px";
        startPos = null;
        render_svgs();
        event.interaction.x = 0;
        event.interaction.y = 0;
        event.target.setAttribute('data-x', event.interaction.x);
        event.target.setAttribute('data-y', event.interaction.y);
    })
    .on('dragmove', function (event) {
        event.interaction.x += event.dx;
        event.interaction.y += event.dy;

        if (transformProp) {
            event.target.style[transformProp] =
                'translate(' + event.interaction.x + 'px, ' + event.interaction.y + 'px)';
        }
        else {
            var lw = -20; // this is the width of the draggable element
            var lh = -10; // this is the width of the draggable element
            event.target.style.left = CUR_POS_X + lw + event.interaction.x + 'px';
            event.target.style.top  = CUR_POS_Y + lh + event.interaction.y + 'px';
        }
    })
    .on('dragleave', function (event) {
        event.draggable.snap(false);

        // when leaving a dropzone, snap to the start position
        event.draggable.snap({ anchors: [startPos] });

        // remove the drop feedback style
        event.target.classList.remove('drop-target');
        event.relatedTarget.classList.remove('can-drop');
    });

setupDropzone('.js-drop', '.js-drag');

function getRadioValue(name) {
    var rates = document.getElementsByName(name);
    var rate_value;
    for(var i = 0; i < rates.length; i++){
        if(rates[i].checked){
            rate_value = i;
        }
    }
    return rate_value+1;
}


function setBalance(atp) {
    let d3 = RSLIDER.getValue()/100;
    // Our basic idea here is that the fourth dimension
    // is fixed by the slider, so the others scale to match it.
    // The way it balances depends on our norm.

    $("#d3").text(RSLIDER.getValue() + '%');

//    var normToUse = getRadioValue("norm");

  //    var norm_to_use = (normToUse == 1 ? L1 :L2);
   var norm_to_use = L1;

    let bal = TriadBalance2to3(atp,WORLD_TRIANGLE_COORDS,norm_to_use);

    var balancep = document.getElementById("balancefourth").checked;
    if (balancep) {

        // Now balance needs be scaled ...
        // If we are using the L1NORM, it is linear.
        // If we are using the L2NORM, c = sqrt(1 - a^2).
        var c;
        // one can conjecture here that c = (1 - d3**n)**(1/n) for other norms
        if (norm_to_use == L1) {
            c = 1 - d3;
        } else {
            c = Math.sqrt( 1 - d3**2);
        }
        bal.multiplyScalar(c);
    }

    $( "#d0" ).text( (bal.x * 100).toFixed(0) +  "%" );
    $( "#d1" ).text( (bal.y * 100).toFixed(0) +  "%" );
    $( "#d2" ).text( (bal.z * 100).toFixed(0) +  "%" );
    $( "#d3" ).text( (d3 * 100).toFixed(0) +  "%" );
    return [bal.x,bal.y,bal.z,d3];
}
/**
 * Setup a given element as a dropzone.
 *
 * @param {HTMLElement|String} el
 * @param {String} accept
 */
function setupDropzone (el, accept) {
    interact(el)
        .on('dropactivate', e => { console.log(e.type);
                                   // I copied this from interact.js, but it produces an error --- however it,
                                   // is absolutely requried!
                                   e.reject();
                                 })
        .dropzone({
            accept: accept,
            ondropactivate: function (event) {
                addClass(event.relatedTarget, '-drop-possible');
            },
            ondropdeactivate: function (event) {
                removeClass(event.relatedTarget, '-drop-possible');
            },
        })
        .on('dropactivate', function (event) {
            const active = event.target.getAttribute('active')|0;

            // change style if it was previously not active
            if (active === 0) {
                addClass(event.target, '-drop-possible');
                event.target.textContent = 'Drop me here!';
            }

            event.target.setAttribute('active', active + 1);
        })
        .on('dropdeactivate', function (event) {
            const active = event.target.getAttribute('active')|0;

            // change style if it was previously active
            // but will no longer be active
            if (active === 1) {
                removeClass(event.target, '-drop-possible');
                event.target.textContent = 'Dropzone';
            }

            event.target.setAttribute('active', active - 1);
        })
        .on('dragenter', function (event) {
            addClass(event.target, '-drop-over');
            event.relatedTarget.textContent = 'I\'m in';
            event.relatedTarget.style.width = "50px";
            event.relatedTarget.style.height = "30px";
            event.relatedTarget.style.fontSize = "xx-small";
        })
        .on('dragleave', function (event) {
            removeClass(event.target, '-drop-over');
            event.relatedTarget.textContent = 'Drag me…';
        })
        .on('drop', function (event) {
            removeClass(event.target, '-drop-over');
            event.relatedTarget.textContent = 'Dropped';
            var element = event.relatedTarget;
            var draggedBox = element.getBoundingClientRect();
            element.textContent = CUR_TEXT;
            var droppableBox = event.target.getBoundingClientRect();
            var xc = event.dragEvent.clientX;
            var yc = event.dragEvent.clientY;
            var y = yc - droppableBox.y;
            var x = xc - droppableBox.x;
            // we need to convert this to "world" coordinates, not viewport...
            var yc = -(y + -200);
            var xc = x + -200;
            var triangle_coords = new THREE.Vector2(xc,yc);

            // Note, we could balance and invert here to make sure we are inside the trianble!
            CUR_TRIANGLE_COORDS = triangle_coords;
            var bal = setBalance(triangle_coords);
            var vec = new THREE.Vector3(bal[0],bal[1],bal[2]);

//            var normToUse = getRadioValue("norm");
          //            var norm_to_use = (normToUse == 1 ? L1 :L2);
          norm_to_use = L1;
            var inv = invertTriadBalance2to3(vec,WORLD_TRIANGLE_COORDS,norm_to_use);
            // This is a hack
            triangle_coords = inv;


            // this is sort of any ugly way to do this
            var color;
            if ($('#nav-projects.tab-pane.fade.show.active').length) {
                ADDED_TET_PROJs.push(triangle_coords);
                color = "blue";
            }
            if ($('#nav-persons.tab-pane.fade.show.active').length) {
                ADDED_TET_PERSs.push(triangle_coords);
                color = "red";
            }
            if ($('#nav-places.tab-pane.fade.show.active').length) {
                ADDED_TET_PLACs.push(triangle_coords);
                color = "greeen";
            }
            if ($('#nav-tools.tab-pane.fade.show.active').length) {
                ADDED_TET_TOOLs.push(triangle_coords);
                color = "orange";
            }

//            setBalance(triangle_coords);
            let d3 = RSLIDER.getValue()/100;
            // now when we form this, the graphics
            // system treats the x axis as the first dimension,
            // the z axis is the other two (positive vs. negative),
            // and the y axis as up and down!

            var for3dTet = new THREE.Vector3(-xc/200,d3,-yc/200);
            // I need to be more careful about the handedness of my system
            add_data_object_aux(for3dTet,CUR_TEXT,color);

            render_svgs();
        });
}

function addClass (element, className) {
    if (element.classList) {
        return element.classList.add(className);
    }
    else {
        element.className += ' ' + className;
    }
}

function removeClass (element, className) {
    if (element.classList) {
        return element.classList.remove(className);
    }
    else {
        element.className = element.className.replace(new RegExp(className + ' *', 'g'), '');
    }
}

interact(document).on('ready', function () {
    transformProp = 'transform' in document.body.style
        ? 'transform': 'webkitTransform' in document.body.style
        ? 'webkitTransform': 'mozTransform' in document.body.style
        ? 'mozTransform': 'oTransform' in document.body.style
        ? 'oTransform': 'msTransform' in document.body.style
        ? 'msTransform': null;
});

WORLD_TRIANGLE_COORDS = get_world_triangle();

testAllTriadBalance(WORLD_TRIANGLE_COORDS);
    init_3d(400,800);
   animate();
</script>


<script>

</script>
</body>
</html>
