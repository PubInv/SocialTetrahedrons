<!--
Copyright (C) 2019 by
  Robert L. Read <read.robert@gmail.com>
  
  This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.0/bootstrap-slider.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/interactjs@1.3/dist/interact.min.js"></script>

  <link rel="stylesheet" href="./css/bootstrap-slider.css"></script>
    <style>

#ex1Slider .slider-selection {
	background: #BABABA;
}
      /* Tabs*/
section {
    padding: 60px 0;
}

section .section-title {
    text-align: center;
    color: #007b5e;
    margin-bottom: 50px;
    text-transform: uppercase;
}
#tabs{
	background: #007b5e;
    color: #eee;
}
#tabs h6.section-title{
    color: #eee;
}

#tabs .nav-tabs .nav-item.show .nav-link, .nav-tabs .nav-link.active {
    color: #f3f3f3;
    background-color: transparent;
    border-color: transparent transparent #f3f3f3;
    border-bottom: 4px solid !important;
    font-size: 20px;
    font-weight: bold;
}
#tabs .nav-tabs .nav-link {
    border: 1px solid transparent;
    border-top-left-radius: .25rem;
    border-top-right-radius: .25rem;
    color: #eee;
    font-size: 20px;
}

canvas {
    border: 1px solid black;
    width: 100%;
    height: 400px;
}

    </style>

    <style>
      body { font-family: Helvetica, Arial, sans-serif; }

.dropzone-wrapper {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
}

.dropzone {
    overflow: hidden;
    margin: .5em;
    padding: 1em;
    color: #666;
    text-align: center;
    background: #ccc;
    line-height: 8em;
    border: 4px dashed transparent;
    transition: background .15s linear, border-color .15s linear;
}

.dropzone.-drop-possible { border-color: #666; }

.dropzone.-drop-over {
    background: #666;
    color: #fff;
}

.draggable {
    position: relative;
    z-index: 10;
    width: 200px;
    margin: .25em;
    padding: 1em 2em;
    background-color: #29e;
    color: #fff;
    text-align: center;

    -ms-touch-action: none;
        touch-action: none;
}

.draggable.-drop-possible { background-color: #42bd41; }

      </style>

<body>
<br>
<div class="container">

  	<h6 class="section-title h1">Tabs</h6>
		<div class="row">
    <div class="col">
				<nav>
					<div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
						<a class="nav-item nav-link active" id="nav-create-tab" data-toggle="tab" href="#nav-create" role="tab" aria-controls="nav-create" aria-selected="true">Create Social Tetrahedrons</a>
						<a class="nav-item nav-link" id="nav-show-tab" data-toggle="tab" href="#nav-social" role="tab" aria-controls="nav-show" aria-selected="false">Show Social Tetrahedrons</a>
					</div>
				</nav>
				<div class="tab-content py-3 px-3 px-sm-0" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-create" role="tabpanel" aria-labelledby="nav-create-tab">

 <div class="row">
      <div class="col-2 col-sm-1">
    <input id="ex4" type="text" data-slider-min="-5" data-slider-max="20" data-slider-step="1" data-slider-value="-3" data-slider-orientation="vertical"/>    
      </div>
    <div class="col-4 col-sm-11">
    
    <div id="create-canvas">
<!-- <div class="dropzone-wrapper"> -->
  <svg id="create_svg"  class="dropzone js-drop" height="500" width="500" viewbox="-250 -250 500 500"> 
</svg>
<!-- </div> -->
    </div>
      </div>
    </div>
    
					</div>
					<div class="tab-pane fade" id="nav-social" role="tabpanel" aria-labelledby="nav-show-tab">
    <div id="social-canvas">
    <canvas id='socialcanvasid'>
    <\canvas>
    </div>
					</div>
    </div>


    
			</div>
                        
			<div class="col">
				<nav>
					<div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
						<a class="nav-item nav-link active" id="nav-projects-tab" data-toggle="tab" href="#nav-projects" role="tab" aria-controls="nav-projects" aria-selected="true">Projects</a>
						<a class="nav-item nav-link" id="nav-persons-tab" data-toggle="tab" href="#nav-persons" role="tab" aria-controls="nav-persons" aria-selected="false">Persons</a>
						<a class="nav-item nav-link" id="nav-places-tab" data-toggle="tab" href="#nav-places" role="tab" aria-controls="nav-places" aria-selected="false">Places</a>
						<a class="nav-item nav-link" id="nav-tools-tab" data-toggle="tab" href="#nav-tools" role="tab" aria-controls="nav-tools" aria-selected="false">Tools</a>
					</div>
				</nav>
				<div class="tab-content py-3 px-3 px-sm-0" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-projects" role="tabpanel" aria-labelledby="nav-projects-tab">

<ul class="list-group" id="nav-projects-list">
  <li class="list-group-item active">Cras justo odio</li>
</ul>
					</div>
					<div class="tab-pane fade" id="nav-persons" role="tabpanel" aria-labelledby="nav-persons-tab">
<ul class="list-group" id="nav-persons-list">
  <li class="list-group-item active">Cras justo odio</li>
</ul>

					</div>
					<div class="tab-pane fade" id="nav-places" role="tabpanel" aria-labelledby="nav-places-tab">
<ul class="list-group" id="nav-places-list">
  <li class="list-group-item active">Cras justo odio</li>
</ul>
								</div>
					<div class="tab-pane fade" id="nav-tools" role="tabpanel" aria-labelledby="nav-tools-tab">
<ul class="list-group" id="nav-tools-list">
  <li class="list-group-item active">Cras justo odio</li>
</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 
<div id="drag1" class="draggable js-drag">Drag me…</div>
<div id="drag2" class="draggable js-drag">Drag me…</div>
<div id="drag3" class="draggable js-drag">Drag me…</div>
    <div id="drag4" class="draggable js-drag">Drag me…</div>
    -->


   <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <script src="./js/bootstrap-slider.js"></script>
    
    <script>

// Trying now to create a basic object model in JavaScript which can later be tied to
// to a datamodel

// OBJECTS
// Effectively thise arrays represent an in-memory databes before we hook up Redis or Firebase or something.

var PROJECTS = [];
var PERSONS = [];
var PLACES = [];
var TOOLS = [];

// Now some constructors to give these things some shapes

function Project(name,source,url) {
    this.name = name;
    this.source = source;
    this.url = url;
}

function Person(name,email) {
    this.name = name;
    this.email = email;
}

function Place(name,lat,lon) {
    this.lat = lat;
    this.lon = lon;
    this.name = name;
}

function Tool(name,level) {
    this.name = name;
    this.level = level;
}

function TetType(type,A_name,B_name,C_name,D_name) {
    this.type = type;
    this.A_Name = A_name;
    this.B_Name = B_name;
    this.C_Name = C_name;
    this.D_Name = D_name;
}

function MBSCTet() {
    TetType.call(this,"MBSC","Mind","Body","Spirit","Comfort");
}

function Tetrahedron(key,type) {
    this.key = key;
    this.type = type;
    // I'm assuming these are the four independent dimensions
    // and that the type gives the names of these dimensions
    this.A = 0;
    this.B = 0;
    this.C = 0;
    this.D = 0;
}

// Now, before I will create a function to populate a test database....

function InitDatabase() {
    PROJECTS.push(new Project('Gluss (robotic truss)','Public Invention','https://pubinv.github.io/tetrobot/'));
    PROJECTS.push(new Project('Geotagtext','Public Invention','https://github.com/PubInv/geotagtext'));
    PERSONS.push(new Person('Robert L. Read','read.robert@gmail.com'));
    PLACES.push(new Place('Poindexter\'s Lab',30.252408, -97.774618));
    TOOLS.push(new Tool('JavaScript',4));
}

function list_item(content) {
    return '<li class="list-group-item">'+content+'</li>';
}
function list_item_draggable(content) {
    return '<li class="list-group-item draggable js-drag">'+content+'</li>';    
        // <div id="drag1" class="draggable js-drag">Drag me…</div>
        // <div id="drag2" class="draggable js-drag">Drag me…</div>
        // <div id="drag3" class="draggable js-drag">Drag me…</div>
        // <div id="drag4" class="draggable js-drag">Drag me…</div>
}
// These function convert my abstract coordinates
// to canvas coordinates.
function vph(h,y) { return (-y); }
function vpw(w,x) { return (x); }

var ADDED_TET_POS;

function render_create_svg() {
    var svg = $("#create_svg")[0];
    $("#create_svg").empty();
    var polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    svg.appendChild(polygon);

    const TRIANGLE_WIDTH = 1;
    const TRIANGLE_HEIGHT = Math.sqrt(3)/2;
    const SIDE_LENGTH_PIXEL = 400;
    const SIDE_LENGTH_HEIGHT = SIDE_LENGTH_PIXEL * TRIANGLE_HEIGHT;
    const BASE = -(1/3) * SIDE_LENGTH_HEIGHT;

    const w = 500;
    const h = 500;

    var array = arr = [ [ vpw(w,-SIDE_LENGTH_PIXEL/2),vph(h,BASE) ], 
                        [ vpw(w,SIDE_LENGTH_PIXEL/2),vph(h,BASE) ],
                        [ vpw(w,0),vph(h,BASE+SIDE_LENGTH_HEIGHT) ] ];
    
    for (value of array) {
        var point = svg.createSVGPoint();
        point.x = value[0];
        point.y = value[1];
        polygon.points.appendItem(point);
    }
    polygon.style.fill='pink';

    if (ADDED_TET_POS) {
        var polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        svg.appendChild(polygon);
        var F = 0.05;
//        ADDED_TET_POS = {x: -100, y:100};

        var array = arr = [ [ vpw(w,ADDED_TET_POS.x + F*-SIDE_LENGTH_PIXEL/2),vph(h,ADDED_TET_POS.y + F*BASE) ], 
                        [ vpw(w,ADDED_TET_POS.x + F*SIDE_LENGTH_PIXEL/2),vph(h,ADDED_TET_POS.y + F*BASE) ],
                        [ vpw(w,ADDED_TET_POS.x + 0),vph(h,ADDED_TET_POS.y + F*(BASE+SIDE_LENGTH_HEIGHT)) ] ];
    for (value of array) {
        var point = svg.createSVGPoint();
        point.x = value[0];
        point.y = value[1];
        polygon.points.appendItem(point);
}
console.log("ARRAY",array);
    polygon.style.fill='blue';
    svg.appendChild(polygon);
        
    }
}

function render(groupid,array,f) {
    //actually, we need an Html element to add to here,
    //but I will just do this.
    $(groupid).empty();
    array.forEach(p => {
        $(groupid).append(list_item_draggable(f(p)));
    });
}

function render_svgs() {
    render_create_svg();
}

function main() {
    InitDatabase();
    render('#nav-projects-list',PROJECTS,(p => p.name));
    render('#nav-persons-list',PERSONS,(p => p.name));
    render('#nav-places-list',PLACES,(p => p.name));
    render('#nav-tools-list',TOOLS,(p => p.name));
//    render_canvases();
    render_svgs();

    // With JQuery
$("#ex4").slider({
	reversed : true
});

}


// A $( document ).ready() block.
$( document ).ready(function() {
    console.log( "ready!" );
    main();
                            });


let transformProp;

interact.maxInteractions(Infinity);

var ORIG_CUR_POS;
var startPos;
var CUR_WIDTH;
var CUR_HEIGHT;
var CUR_FONT_SIZE;
var CUR_TEXT;

// setup draggable elements.
interact('.js-drag')
  .draggable({
      max: Infinity,
//    snap: {
//      targets: [interact.createSnapGrid({ x: 100, y: 100 })],
//      relativePoints: [{ x: 0.5, y: 0.5 }],
//    },
  })
  .on('dragstart', function (event) {
    event.interaction.x = parseInt(event.target.getAttribute('data-x'), 10) || 0;
      event.interaction.y = parseInt(event.target.getAttribute('data-y'), 10) || 0;
      if (!startPos) {
          var rect = interact.getElementRect(event.target);

          // record center point when starting the very first a drag
          startPos = {
              x: rect.left + rect.width  / 2,
              y: rect.top  + rect.height / 2
          }
        CUR_WIDTH = event.target.style.width;
        CUR_HEIGHT = event.target.style.height;
        CUR_FONT_SIZE = event.target.style.fontSize;
          CUR_TEXT = event.target.textContent;
          console.log("CUR_TEXT",CUR_TEXT);
          console.log("startPos",startPos);
      };
      console.log("START",event.target.getAttribute('data-x'),event.target.getAttribute('data-y'));
  })
    .on('dragend',function (event) {
        console.log("END",event.target);
        console.log("END",event.target.getAttribute('data-x'),event.target.getAttribute('data-y'));        
        event.target.style.width = CUR_WIDTH;
        event.target.style.height = CUR_HEIGHT;
        event.target.style.fontSize = CUR_FONT_SIZE;
        event.target.textContent = CUR_TEXT;        
        event.target.style.left = "" + 0 + "px";
        event.target.style.top = "" + 0 + "px";
        startPos = null;
        render_svgs();
  })
  .on('dragmove', function (event) {
    event.interaction.x += event.dx;
    event.interaction.y += event.dy;

    if (transformProp) {
      event.target.style[transformProp] =
        'translate(' + event.interaction.x + 'px, ' + event.interaction.y + 'px)';
    }
    else {
      event.target.style.left = event.interaction.x + 'px';
      event.target.style.top  = event.interaction.y + 'px';
    }
  })
 .on('dragleave', function (event) {
        event.draggable.snap(false);

        // when leaving a dropzone, snap to the start position
        event.draggable.snap({ anchors: [startPos] });

        // remove the drop feedback style
        event.target.classList.remove('drop-target');
        event.relatedTarget.classList.remove('can-drop');
    })
  .on('dragend', function (event) {
    event.target.setAttribute('data-x', event.interaction.x);
    event.target.setAttribute('data-y', event.interaction.y);
  });

// setup drop areas.
// dropzone #1 accepts draggable #1
// setupDropzone('#create_svg', '#drag1');
// setupDropzone('#create_svg', '#drag1');
// dropzone #2 accepts draggable #1 and #2
// setupDropzone('#create_svg', '#drag1, #drag2');
// every dropzone accepts draggable #3
setupDropzone('.js-drop', '.js-drag');



/**
 * Setup a given element as a dropzone.
 *
 * @param {HTMLElement|String} el
 * @param {String} accept
 */
function setupDropzone (el, accept) {
  interact(el)
    .on('dropactivate', e => { console.log(e.type); e.reject(); })
    .dropzone({
      accept: accept,
      ondropactivate: function (event) {
        addClass(event.relatedTarget, '-drop-possible');
      },
      ondropdeactivate: function (event) {
        removeClass(event.relatedTarget, '-drop-possible');
      },
    })
    .on('dropactivate', function (event) {
      const active = event.target.getAttribute('active')|0;

      // change style if it was previously not active
      if (active === 0) {
        addClass(event.target, '-drop-possible');
        event.target.textContent = 'Drop me here!';
      }

      event.target.setAttribute('active', active + 1);
    })
    .on('dropdeactivate', function (event) {
      const active = event.target.getAttribute('active')|0;

      // change style if it was previously active
      // but will no longer be active
      if (active === 1) {
        removeClass(event.target, '-drop-possible');
        event.target.textContent = 'Dropzone';
      }

      event.target.setAttribute('active', active - 1);
    })
    .on('dragenter', function (event) {
        addClass(event.target, '-drop-over');
        event.relatedTarget.textContent = 'I\'m in';
        event.relatedTarget.style.width = "50px";
        event.relatedTarget.style.height = "30px";
        event.relatedTarget.style.fontSize = "xx-small";
    })
    .on('dragleave', function (event) {
      removeClass(event.target, '-drop-over');
      event.relatedTarget.textContent = 'Drag me…';
    })
    .on('drop', function (event) {
        console.log("drop event",event);
      removeClass(event.target, '-drop-over');
        event.relatedTarget.textContent = 'Dropped';
        var element = event.relatedTarget;
        console.log("element",element.offsetLeft,element.offsetTop);
        console.log("this", event.target.offsetLeft,event.target.offsetTop);
        var draggedBox = element.getBoundingClientRect();
        element.textContent = CUR_TEXT;                
        var droppableBox = event.target.getBoundingClientRect();
        console.log("bounding",
                    event.target.getBoundingClientRect());
        console.log("bounding",
                    draggedBox);
        var xc = event.dragEvent.clientX;
        var yc = event.dragEvent.clientY;
        console.log("xc,yc",xc,yc);
        var y = yc - droppableBox.y;
        var x = xc - droppableBox.x;
        // we need to convert this to "world" coordinates, not viewport...
        var yc = -(y + -250);
        var xc = x + -250;
        console.log("Y",yc);
        console.log("X",xc);
        ADDED_TET_POS = {x: xc,y: yc};
        console.log("setting ADDED_TET_POS",ADDED_TET_POS);
        render_svgs();
    });
}

function addClass (element, className) {
  if (element.classList) {
    return element.classList.add(className);
  }
  else {
    element.className += ' ' + className;
  }
}

function removeClass (element, className) {
  if (element.classList) {
    return element.classList.remove(className);
  }
  else {
    element.className = element.className.replace(new RegExp(className + ' *', 'g'), '');
  }
}

interact(document).on('ready', function () {
  transformProp = 'transform' in document.body.style
    ? 'transform': 'webkitTransform' in document.body.style
      ? 'webkitTransform': 'mozTransform' in document.body.style
        ? 'mozTransform': 'oTransform' in document.body.style
          ? 'oTransform': 'msTransform' in document.body.style
            ? 'msTransform': null;
});

                            
      </script>

</body>
</html>
